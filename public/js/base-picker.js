class BasePicker{constructor(config){this.currentYear=config.currentYear;this.currentMonth=config.currentMonth;this.currentDay=config.currentDay;this.labels=config.labels||[];this.dataValues=config.dataValues||[];this.ajaxUrl=config.ajaxUrl;this.calendarAjaxUrl=config.calendarAjaxUrl;this.currentChart=null;this.overlay=null;this.lunarCache={};this.apiCache={};this.cacheTimeout=300000;this.eventListeners=[]}
getCurrentDate(){return new Date(this.currentYear,this.currentMonth-1,this.currentDay)}
debounce(func,delay){let timeoutId;return function(...args){clearTimeout(timeoutId);timeoutId=setTimeout(()=>func.apply(this,args),delay)}}
getCsrfToken(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||''}
validateDate(day,month,year){return day>=1&&day<=31&&month>=1&&month<=12&&year>=1800&&year<=2300}
showToast(message,type='info'){document.querySelectorAll('.toast').forEach(toast=>toast.remove());const toast=document.createElement('div');toast.className=`toast toast-${type}`;toast.textContent=message;toast.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: ${type === 'error' ? '#f44336' : '#4caf50'};
            color: white;
            border-radius: 4px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
        `;document.body.appendChild(toast);requestAnimationFrame(()=>toast.style.opacity='1');setTimeout(()=>{toast.style.opacity='0';setTimeout(()=>toast.remove(),300)},3000)}
addEventListenerTracked(element,event,handler,options={}){element.addEventListener(event,handler,options);this.eventListeners.push({element,event,handler,options});return{element,event,handler,options}}
destroy(){this.eventListeners.forEach(({element,event,handler})=>{if(element&&element.removeEventListener){element.removeEventListener(event,handler)}});this.eventListeners=[];this.lunarCache={};this.apiCache={};if(this.currentChart){this.currentChart.destroy();this.currentChart=null}
if(this.overlay){this.overlay.remove();this.overlay=null}}
getCacheKey(prefix,...args){return `${prefix}_${args.join('_')}`}
setCache(key,data){this.apiCache[key]={data,timestamp:Date.now()}}
getCache(key){const cached=this.apiCache[key];if(cached&&(Date.now()-cached.timestamp)<this.cacheTimeout){return cached.data}
delete this.apiCache[key];return null}
async generatePopupCalendarOptimized(month,year,highlightDay=null){const calendarTable=document.querySelector('.calendar-wrapper .calendar-table');const popupCalendarDays=document.getElementById('popupCalendarDays');if(calendarTable)calendarTable.style.pointerEvents='none';if(popupCalendarDays)popupCalendarDays.style.pointerEvents='none';try{const calendarDays=document.getElementById('popupCalendarDays');if(!calendarDays)return;const firstDay=new Date(year,month-1,1);const lastDay=new Date(year,month,0);const daysInMonth=lastDay.getDate();const startingDayOfWeek=firstDay.getDay()===0?6:firstDay.getDay()-1;let calendarHTML='';for(let i=0;i<startingDayOfWeek;i++){calendarHTML+='<div class="calendar-day empty"></div>'}
const selectedDay=highlightDay||parseInt(document.getElementById('solarDay')?.value||this.currentDay);const selectedMonth=parseInt(document.getElementById('solarMonth')?.value||this.currentMonth);const selectedYear=parseInt(document.getElementById('solarYear')?.value||this.currentYear);for(let day=1;day<=daysInMonth;day++){const isSelected=(year===selectedYear&&month===selectedMonth&&day===selectedDay);const selectedClass=isSelected?' current-day selected':'';calendarHTML+=`
                <div class="calendar-day${selectedClass}" style="position: relative" data-day="${day}" data-month="${month}" data-year="${year}">
                    <span>${day}</span>
                    <div class="lunar-date-popup" data-day="${day}">...</div>
                </div>
            `}
calendarDays.innerHTML=calendarHTML;this.setupCalendarDayListeners(calendarDays,month,year);await this.updateLunarDatesOptimized(calendarDays,month,year,daysInMonth)}finally{if(calendarTable)calendarTable.style.pointerEvents='auto';if(popupCalendarDays)popupCalendarDays.style.pointerEvents='auto'}}
async updateLunarDatesOptimized(calendarDays,month,year,daysInMonth){const cacheKey=this.getCacheKey('lunar',year,month);const cachedData=this.getCache(cacheKey);if(cachedData){this.applyLunarDatesToCalendar(calendarDays,cachedData);return}
try{const lunarDatesMap=await this.fetchLunarDatesForMonth(month,year,daysInMonth);this.setCache(cacheKey,lunarDatesMap);this.applyLunarDatesToCalendar(calendarDays,lunarDatesMap)}catch(error){this.showToast('Lỗi tải dữ liệu âm lịch','error')}}
applyLunarDatesToCalendar(calendarDays,lunarDatesMap){const lunarSpans=calendarDays.querySelectorAll('.lunar-date-popup[data-day]');lunarSpans.forEach(span=>{const day=parseInt(span.dataset.day);if(lunarDatesMap[day]){const lunarData=lunarDatesMap[day];let displayText=lunarData.lunarDay;if(day==1||lunarData.lunarDay==1){displayText=`${lunarData.lunarDay}/${lunarData.lunarMonth}`}span.textContent=displayText}})}
updatePopupHeader(month,year){const monthSpan=document.getElementById('popupMonth');const yearSpan=document.getElementById('popupYear');if(monthSpan)monthSpan.textContent=month.toString().padStart(2,'0');if(yearSpan)yearSpan.textContent=year}
closePopup(overlay){overlay.classList.remove('show');document.body.classList.remove('modal-open');document.body.classList.remove('has-scrollbar');setTimeout(()=>{overlay.style.display='none'},300)}
async fetchWithCache(url,options,cacheKey){const cachedData=this.getCache(cacheKey);if(cachedData){return cachedData}
try{const response=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':this.getCsrfToken(),'Accept':'application/json'},...options});const data=await response.json();if(data.success){this.setCache(cacheKey,data)}
return data}catch(error){throw error}}
async fetchLunarDatesForMonth(month,year,daysInMonth){const cacheKey=this.getCacheKey('lunar_month',year,month);try{const data=await this.fetchWithCache('/api/get-month-lunar-dates',{body:JSON.stringify({month:month,year:year})},cacheKey);if(data.success&&data.dates){return data.dates}else{throw new Error(data.error||'Lỗi lấy dữ liệu âm lịch')}}catch(error){throw error}}
async convertSolarToLunar(){const solarDay=document.getElementById('solarDay')?.value;const solarMonth=document.getElementById('solarMonth')?.value;const solarYear=document.getElementById('solarYear')?.value;if(!this.validateDate(parseInt(solarDay),parseInt(solarMonth),parseInt(solarYear))){this.showToast('Ngày không hợp lệ','error');return}
const cacheKey=this.getCacheKey('solar_to_lunar',solarYear,solarMonth,solarDay);try{const data=await this.fetchWithCache('/api/convert-solar-to-lunar',{body:JSON.stringify({solarDay:parseInt(solarDay),solarMonth:parseInt(solarMonth),solarYear:parseInt(solarYear)})},cacheKey);if(data.success){await this.populateLunarMonthSelect(data.lunarYear);const lunarDaySelect=document.getElementById('lunarDay');const lunarYearSelect=document.getElementById('lunarYear');if(lunarDaySelect)lunarDaySelect.value=data.lunarDay;if(lunarYearSelect)lunarYearSelect.value=data.lunarYear;await this.selectCorrectLunarMonth(data.lunarMonth,data.isLeap||false)}}catch(error){this.showToast('Lỗi chuyển đổi lịch','error')}}
async convertLunarToSolar(){const lunarDay=document.getElementById('lunarDay')?.value;const lunarMonth=document.getElementById('lunarMonth')?.value;const lunarYear=document.getElementById('lunarYear')?.value;if(!this.validateDate(parseInt(lunarDay),parseInt(lunarMonth),parseInt(lunarYear))){this.showToast('Ngày âm lịch không hợp lệ','error');return}
const lunarMonthSelect=document.getElementById('lunarMonth');const selectedOption=lunarMonthSelect.options[lunarMonthSelect.selectedIndex];const isLeapMonth=selectedOption&&selectedOption.dataset.isLeap==='1';const cacheKey=this.getCacheKey('lunar_to_solar',lunarYear,lunarMonth,lunarDay,isLeapMonth?'leap':'normal');try{const data=await this.fetchWithCache('/api/convert-lunar-to-solar',{body:JSON.stringify({lunarDay:parseInt(lunarDay),lunarMonth:parseInt(lunarMonth),lunarYear:parseInt(lunarYear),isLeap:isLeapMonth})},cacheKey);if(data.success){document.getElementById('solarDay').value=data.solarDay;document.getElementById('solarMonth').value=data.solarMonth;document.getElementById('solarYear').value=data.solarYear;this.updatePopupHeader(data.solarMonth,data.solarYear);await this.generatePopupCalendarOptimized(data.solarMonth,data.solarYear,data.solarDay)}}catch(error){this.showToast('Lỗi chuyển đổi lịch âm','error')}}
async populateLunarMonthSelect(year=null){const lunarYear=year||document.getElementById('lunarYear')?.value;const lunarMonthSelect=document.getElementById('lunarMonth');if(!lunarMonthSelect||!lunarYear)return;const currentValue=lunarMonthSelect.value;const currentIsLeap=lunarMonthSelect.options[lunarMonthSelect.selectedIndex]?.dataset?.isLeap==='1';lunarMonthSelect.innerHTML='<option value="">Đang tải...</option>';lunarMonthSelect.disabled=true;try{let leapMonthNumber=0;const knownLeapYears={2025:6,2028:5,2031:3,2033:11,2036:6,2039:5,2042:2,2044:7,2047:5,2050:3,2052:8,2055:6,2058:4,2061:3,2063:7,2066:5,2069:4,2071:8,2074:6,2077:4,2080:3,2082:7,2085:5,2088:4,2090:6,2093:5,2096:2,2099:7,2101:5};if(knownLeapYears[parseInt(lunarYear)]){leapMonthNumber=knownLeapYears[parseInt(lunarYear)]}else{for(let m=1;m<=12;m++){try{const response=await fetch('/api/get-lunar-month-days',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':this.getCsrfToken(),'Accept':'application/json'},body:JSON.stringify({month:m,year:parseInt(lunarYear),isLeap:1})});if(!response.ok)break;const data=await response.json();if(data.success&&data.days>0){leapMonthNumber=m;break}}catch(error){console.error('Error checking leap month:',error);break}}}
lunarMonthSelect.innerHTML='<option value="">Tháng</option>';lunarMonthSelect.disabled=false;for(let i=1;i<=12;i++){const option=document.createElement('option');option.value=i;option.textContent=`Tháng ${i}`;option.dataset.isLeap='0';lunarMonthSelect.appendChild(option);if(i===leapMonthNumber){const leapOption=document.createElement('option');leapOption.value=i;leapOption.textContent=`Tháng ${i} nhuận`;leapOption.dataset.isLeap='1';lunarMonthSelect.appendChild(leapOption)}}
if(currentValue){const wasLeapAndStillExists=currentIsLeap&&leapMonthNumber==currentValue;const shouldUseLeap=wasLeapAndStillExists;this.selectCorrectLunarMonth(parseInt(currentValue),shouldUseLeap)}}catch(error){console.error('Error populating lunar months:',error);lunarMonthSelect.innerHTML='<option value="">Lỗi tải dữ liệu</option>';lunarMonthSelect.disabled=false}}
async selectCorrectLunarMonth(monthValue,isLeap=false){const lunarMonthSelect=document.getElementById('lunarMonth');if(!lunarMonthSelect)return;for(let i=0;i<lunarMonthSelect.options.length;i++){const option=lunarMonthSelect.options[i];if(option.value==monthValue){if((isLeap&&option.dataset.isLeap==='1')||(!isLeap&&option.dataset.isLeap!=='1')){lunarMonthSelect.selectedIndex=i;await this.updateLunarDaysInMonth();break}}}}
async updateLunarDaysInMonth(){const lunarDay=document.getElementById('lunarDay');const lunarMonth=document.getElementById('lunarMonth');const lunarYear=document.getElementById('lunarYear');if(!lunarDay||!lunarMonth||!lunarYear)return;const month=parseInt(lunarMonth.value);const year=parseInt(lunarYear.value);const currentDay=parseInt(lunarDay.value);if(!month||!year)return;const selectedOption=lunarMonth.options[lunarMonth.selectedIndex];const isLeapMonth=selectedOption&&selectedOption.dataset.isLeap==='1';try{const response=await fetch('/api/get-lunar-month-days',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':this.getCsrfToken(),'Accept':'application/json'},body:JSON.stringify({month:month,year:year,isLeap:isLeapMonth?1:0})});const data=await response.json();if(data.success&&data.days>0){const daysInMonth=data.days;lunarDay.innerHTML='<option value="">Ngày</option>';for(let i=1;i<=daysInMonth;i++){const option=document.createElement('option');option.value=i;option.textContent=String(i).padStart(2,'0');lunarDay.appendChild(option)}
if(currentDay&&currentDay<=daysInMonth){lunarDay.value=currentDay}}}catch(error){console.error('Error getting lunar month days:',error)}}
setupCalendarDayListeners(calendarDays,month,year){throw new Error('setupCalendarDayListeners must be implemented by subclass')}
init(){}
onDateSelected(year,month,day){}}
window.BasePicker=BasePicker