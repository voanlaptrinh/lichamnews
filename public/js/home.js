class LunarCalendarApp extends BasePicker{
constructor(config){super(config);this.isUpdatingLunar=false}
init(){this.setupDateRangePicker();this.setupChart();this.setupNavigationButtons();this.setupMonthYearSelects();this.setupCalendarClickHandler();this.setupQuickPicker();this.setupPopstateHandler()}
setupCalendarDayListeners(calendarDays,month,year){calendarDays.removeEventListener('click',this.calendarDayClickHandler);this.calendarDayClickHandler=async(e)=>{const dayElement=e.target.closest('.calendar-day:not(.empty)');if(!dayElement)return;const day=parseInt(dayElement.dataset.day);const month=parseInt(dayElement.dataset.month);const year=parseInt(dayElement.dataset.year);calendarDays.querySelectorAll('.calendar-day').forEach(el=>el.classList.remove('selected'));dayElement.classList.add('selected');const solarDay=document.getElementById('solarDay');const solarMonth=document.getElementById('solarMonth');const solarYear=document.getElementById('solarYear');if(solarDay)solarDay.value=day;if(solarMonth)solarMonth.value=month;if(solarYear)solarYear.value=year;const quickPickerOverlay=document.getElementById('quickPickerOverlay');this.closePopup(quickPickerOverlay);await Promise.all([this.updatePageContent(year,month,day),this.convertSolarToLunar()])};this.addEventListenerTracked(calendarDays,'click',this.calendarDayClickHandler)}
createOverlay(){if(!this.overlay){this.overlay=document.createElement('div');this.overlay.className='daterangepicker-overlay';document.body.appendChild(this.overlay);this.overlay.addEventListener('click',()=>{const monthYearPicker=document.getElementById('month-year-picker');if(monthYearPicker&&monthYearPicker._daterangepicker){monthYearPicker._daterangepicker.hide()}})}
return this.overlay}
setupDateRangePicker(){const monthYearPicker=document.getElementById('month-year-picker');if(!monthYearPicker)return;monthYearPicker.addEventListener('show.daterangepicker',()=>{if(window.innerWidth<=768){const overlay=this.createOverlay();overlay.style.display='block'}});monthYearPicker.addEventListener('hide.daterangepicker',()=>{if(this.overlay){this.closePopup(this.overlay)}})}
setupChart(){const canvas=document.getElementById('myChart');if(!canvas)return;this.currentChart=new SimpleBarChart('myChart',{data:this.dataValues,labels:this.labels});this.currentChart.enableTooltip()}
getCurrentDate(){return new Date(this.currentYear,this.currentMonth-1,this.currentDay)}
needsLunarUpdate(year,month,day){const solarDaySelect=document.getElementById('solarDay');const solarMonthSelect=document.getElementById('solarMonth');const solarYearSelect=document.getElementById('solarYear');return solarDaySelect&&(parseInt(solarDaySelect.value)!==day||parseInt(solarMonthSelect.value)!==month||parseInt(solarYearSelect.value)!==year)}
updateSelectsWithData(year,month,day,lunarData){const solarDaySelect=document.getElementById('solarDay');const solarMonthSelect=document.getElementById('solarMonth');const solarYearSelect=document.getElementById('solarYear');if(solarDaySelect)solarDaySelect.value=day;if(solarMonthSelect)solarMonthSelect.value=month;if(solarYearSelect)solarYearSelect.value=year;if(lunarData.success){const lunarDaySelect=document.getElementById('lunarDay');const lunarMonthSelect=document.getElementById('lunarMonth');const lunarYearSelect=document.getElementById('lunarYear');if(lunarDaySelect)lunarDaySelect.value=lunarData.lunarDay;if(lunarMonthSelect)lunarMonthSelect.value=lunarData.lunarMonth;if(lunarYearSelect)lunarYearSelect.value=lunarData.lunarYear}}
showToast(message,type='info'){const toast=document.createElement('div');toast.className=`toast toast-${type}`;toast.textContent=message;toast.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: ${type === 'error' ? '#f44336' : '#4caf50'};
            color: white;
            border-radius: 4px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
        `;document.body.appendChild(toast);requestAnimationFrame(()=>toast.style.opacity='1');setTimeout(()=>{toast.style.opacity='0';setTimeout(()=>document.body.removeChild(toast),300)},3000)}
async updatePageContent(year,month,day){const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');const loadingElements=document.querySelectorAll('.date-number, .date-weekday, .date-special-event');loadingElements.forEach(el=>el.style.opacity='0.6');try{const[pageResponse,lunarResponse]=await Promise.all([fetch(this.ajaxUrl,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({yy:year,mm:month,dd:day,birthdate:null})}),this.needsLunarUpdate(year,month,day)?fetch('/api/convert-solar-to-lunar',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({solarDay:day,solarMonth:month,solarYear:year})}):null]);const data=await pageResponse.json();const lunarData=lunarResponse?await lunarResponse.json():null;if(data.success){this.currentYear=year;this.currentMonth=month;this.currentDay=day;const newUrl=`/lich-nam-${year}/thang-${month}/ngay-${day}`;history.pushState({year,month,day},'',newUrl);this.updateUIElements(data.data);if(lunarData&&lunarData.success){this.updateSelectsWithData(year,month,day,lunarData)}
requestAnimationFrame(()=>{this.updatePopupIfOpen(year,month,day);this.updateChart(data.data.labels,data.data.dataValues)})}}catch(error){console.error('Error:',error);this.showToast('C√≥ l·ªói x·∫£y ra. ƒêang th·ª≠ l·∫°i...','error')}finally{loadingElements.forEach(el=>el.style.opacity='1')}}
updateUIElements(data){if(data.metaTitle){document.title=data.metaTitle}
if(data.metaDescription){const metaDescriptionTag=document.querySelector('meta[name="description"]');if(metaDescriptionTag){metaDescriptionTag.setAttribute('content',data.metaDescription)}}
const pageTitle=document.getElementById('page-title');const breadcrumbText=document.getElementById('breadcrumb-text');if(pageTitle){pageTitle.textContent=`L·ªãch √Çm D∆∞∆°ng Ng√†y ${data.dd} Th√°ng ${data.mm} NƒÉm ${data.yy}`}
if(breadcrumbText){breadcrumbText.textContent=` L·ªãch ng√†y ${data.dd}/${data.mm}/${data.yy}`}
const detailContent=document.getElementById('detail-content');if(detailContent&&data.html){detailContent.innerHTML=data.html;this.setupNavigationButtons();this.setupQuickPicker();this.removeCalendarHrefs();this.updateUpcomingEvents(data.upcomingEvents)}
const duongElement=document.querySelector('.date-number.duong');if(duongElement)duongElement.textContent=data.dd;const weekdayElements=document.querySelectorAll('.date-weekday');if(weekdayElements[0]){weekdayElements[0].textContent=data.weekday}
const monthYearElements=document.querySelectorAll('.date-special-event.text-dark');if(monthYearElements[0]){monthYearElements[0].textContent=`Th√°ng ${data.mm} nƒÉm ${data.yy}`}
const amElement=document.querySelector('.date-number.am');if(amElement)amElement.textContent=data.al[0];if(weekdayElements[1]){weekdayElements[1].textContent=`Th√°ng ${data.al[1]} (${data.al[4] || ''}) nƒÉm ${data.getThongTinCanChiVaIcon?.can_chi_nam || ''}`}
if(monthYearElements[1]){monthYearElements[1].textContent=`Ng√†y ${data.getThongTinCanChiVaIcon?.can_chi_ngay || ''} - Th√°ng ${data.getThongTinCanChiVaIcon?.can_chi_thang || ''}`}
const calendarHeaderTitle=document.querySelector('.calendar-header-convert h5');if(calendarHeaderTitle){calendarHeaderTitle.textContent=`L·ªãch v·∫°n ni√™n ${data.yy} - th√°ng ${data.mm}`}
const monthSelect=document.getElementById('month-select');if(monthSelect){monthSelect.value=parseInt(data.mm)}
const yearSelect=document.getElementById('year-select');if(yearSelect){yearSelect.value=parseInt(data.yy)}
const statusElement=document.querySelector('.day-status');if(statusElement){statusElement.className='day-status';if(data.tot_xau_result==='tot'){statusElement.className+=' hoang-dao';statusElement.innerHTML='<span class="status-dot"></span><span class="title-status-dot"> Ho√†ng ƒë·∫°o</span>'}else if(data.tot_xau_result==='xau'){statusElement.className+=' hac-dao';statusElement.innerHTML='<span class="status-dot"></span><span class="title-status-dot"> H·∫Øc ƒë·∫°o</span>'}else{statusElement.innerHTML=''}}
const tietKhiElement=document.querySelector('.icon_tiet_khi')?.nextElementSibling?.querySelector('span');if(tietKhiElement)tietKhiElement.textContent=data.tietkhi?.tiet_khi||'';const napAmElement=document.querySelector('.icon_nap_am')?.nextElementSibling;if(napAmElement)napAmElement.innerHTML=`<strong class="title-font-detail-ngay">Ng≈© h√†nh n·∫°p √¢m:</strong> ${data.getThongTinNgay?.nap_am?.napAm || ''}`;const gioHoangDaoElement=document.querySelector('.icon_hoang_dao')?.nextElementSibling;if(gioHoangDaoElement)gioHoangDaoElement.innerHTML=`<strong class="title-font-detail-ngay">Gi·ªù Ho√†ng ƒë·∫°o:</strong> ${data.getThongTinNgay?.gio_hoang_dao || ''}`;const dialElement=document.querySelector('.progress-dial');if(dialElement){const percentage=Math.round(data.getDaySummaryInfo?.score?.percentage||0);dialElement.style.setProperty('--value',percentage);const percentElement=dialElement.querySelector('.dial-percent');if(percentElement)percentElement.textContent=percentage+'%';const statusElement=dialElement.querySelector('.dial-status');if(statusElement){statusElement.textContent=data.getDaySummaryInfo?.score?.rating||'';statusElement.className='dial-status pt-2';const ratingColors={'T·ªët':'text-success','X·∫•u':'text-danger','Trung b√¨nh':'text-warning-tb',};const colorClass=ratingColors[data.getDaySummaryInfo?.score?.rating];if(colorClass)statusElement.classList.add(colorClass);}}
const calendarBodyContainer=document.getElementById('calendar-body-container');if(calendarBodyContainer&&data.table_html){calendarBodyContainer.querySelector('tbody').innerHTML=data.table_html}
const detailLink=document.querySelector('.btn0mobie');if(detailLink){const newDetailUrl=`/lich-nam-${data.yy}/thang-${data.mm}/ngay-${data.dd}`;detailLink.href=newDetailUrl}
const suKienDuongElements=document.querySelectorAll('.su-kien-duong');suKienDuongElements.forEach(el=>el.remove());if(data.suKienDuongLich&&data.suKienDuongLich.length>0){const containerDuong=document.querySelector('.date-special-event-duong');if(containerDuong){data.suKienDuongLich.forEach(suKien=>{const div=document.createElement('div');div.className='su-kien-duong';div.textContent=suKien.ten_su_kien||suKien;containerDuong.appendChild(div)})}}
const containerAm=document.querySelector('.date-special-event-am');if(containerAm){const suKienAmElements=containerAm.querySelectorAll('.su-kien-duong');suKienAmElements.forEach(el=>el.remove());if(data.suKienAmLich&&data.suKienAmLich.length>0){data.suKienAmLich.forEach(suKien=>{const div=document.createElement('div');div.className='su-kien-duong';div.textContent=suKien.ten_su_kien||suKien;containerAm.appendChild(div)})}}
if(data.upcomingEvents){this.updateUpcomingEvents(data.upcomingEvents)}}
updateUpcomingEvents(upcomingEvents){const upcomingEventsContainer=document.querySelector('.events-list');if(upcomingEventsContainer&&upcomingEvents&&upcomingEvents.length>0){upcomingEventsContainer.innerHTML='';upcomingEvents.forEach(event=>{const eventDate=new Date(event.date);const formattedMonth=(eventDate.getMonth()+1);const formattedDay=eventDate.getDate();const li=document.createElement('li');li.className='list-group-item event-item';const lunarInfo=this.convertSolarToLunarSync(eventDate.getDate(),eventDate.getMonth()+1,eventDate.getFullYear());li.innerHTML=`
                    <a href="/lich-nam-${eventDate.getFullYear()}/thang-${formattedMonth}/ngay-${formattedDay}">
                        <div class="event-date">Ng√†y ${eventDate.getDate()}/${formattedMonth}
                            <span style="font-size: 12px;color: #46494E;font-style: italic;">(${lunarInfo.lunarDay}/${lunarInfo.lunarMonth} √ÇL)</span>
                        </div>
                        <div class="event-icon">üóìÔ∏è</div>
                        <div class="event-details">
                            <div class="event-name">${event.description}</div>
                            <div class="event-countdown">
                                ${event.days_remaining === 0 ?
                                    '<span class="text-danger fw-bold">H√¥m nay</span>' :
                                    event.days_remaining === 1 ?
                                        '<span class="text-warning fw-bold">Ng√†y mai</span>' :
                                        `<span class="text-muted">C√≤n ${event.days_remaining}ng√†y</span>`
                                }
                            </div>
                        </div>
                    </a>
                `;upcomingEventsContainer.appendChild(li)})}}
convertSolarToLunarSync(day,month,year){const solarDate=new Date(year,month-1,day);const lunarNewYear2024=new Date(2024,1,10);const daysDiff=Math.floor((solarDate-lunarNewYear2024)/(1000*60*60*24));const lunarDay=Math.max(1,((daysDiff%30)+1));const lunarMonth=Math.max(1,Math.floor(daysDiff/30)%12+1);return{lunarDay:lunarDay,lunarMonth:lunarMonth,lunarYear:year}}
updateChart(labels,dataValues){if(this.currentChart){this.currentChart.updateData(dataValues,labels)}}
setupNavigationButtons(){const debounceNavigation=this.debounce((callback)=>callback(),300);const prevBtns=document.querySelectorAll('.prev-day-btn');const nextBtns=document.querySelectorAll('.next-day-btn');prevBtns.forEach(btn=>{btn.addEventListener('click',(e)=>{e.preventDefault();if(btn.disabled)return;btn.disabled=!0;window.getSelection().removeAllRanges();debounceNavigation(()=>{const currentDate=this.getCurrentDate();const prevDate=new Date(currentDate);prevDate.setDate(currentDate.getDate()-1);const prevYear=prevDate.getFullYear();const prevMonth=prevDate.getMonth()+1;const prevDay=prevDate.getDate();this.updatePageContent(prevYear,prevMonth,prevDay).finally(()=>{btn.disabled=!1})})})});nextBtns.forEach(btn=>{btn.addEventListener('click',(e)=>{e.preventDefault();if(btn.disabled)return;btn.disabled=!0;window.getSelection().removeAllRanges();debounceNavigation(()=>{const currentDate=this.getCurrentDate();const nextDate=new Date(currentDate);nextDate.setDate(currentDate.getDate()+1);const nextYear=nextDate.getFullYear();const nextMonth=nextDate.getMonth()+1;const nextDay=nextDate.getDate();this.updatePageContent(nextYear,nextMonth,nextDay).finally(()=>{btn.disabled=!1})})})})}
debounce(func,delay){let timeoutId;return function(...args){clearTimeout(timeoutId);timeoutId=setTimeout(()=>func.apply(this,args),delay)}}
setupMonthYearSelects(){const monthSelect=document.getElementById('month-select');const yearSelect=document.getElementById('year-select');const calendarBodyContainer=document.getElementById('calendar-body-container');const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');if(!monthSelect||!yearSelect||!calendarBodyContainer)return;const debounce=(func,delay)=>{let timeout;return function(...args){const context=this;clearTimeout(timeout);timeout=setTimeout(()=>func.apply(context,args),delay)}};const updateCalendar=async()=>{const month=monthSelect.value;const year=yearSelect.value;const h5Element=document.querySelector('.calendar-header-convert h5');if(h5Element){h5Element.textContent=`L·ªãch v·∫°n ni√™n ${year} - th√°ng ${month}`}
try{const response=await fetch(this.calendarAjaxUrl,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken},body:JSON.stringify({nam:year,thang:month})});const data=await response.json();if(data.table_html){calendarBodyContainer.querySelector('tbody').innerHTML=data.table_html;this.removeCalendarHrefs()}}catch(error){console.error('Error fetching calendar data:',error)}};const debouncedUpdateCalendar=debounce(updateCalendar,300);monthSelect.addEventListener('change',debouncedUpdateCalendar);yearSelect.addEventListener('change',debouncedUpdateCalendar)}
setupCalendarClickHandler(){const calendarBodyContainer=document.getElementById('calendar-body-container');if(calendarBodyContainer){this.removeCalendarHrefs();calendarBodyContainer.addEventListener('click',(e)=>{const link=e.target.closest('a[data-date-url]');const linkWithHref=e.target.closest('a[href*="/lich-nam-"]');if(link||linkWithHref){e.preventDefault();if(link){const href=link.getAttribute('data-date-url');this.processCalendarLink(href)}else if(linkWithHref){const href=linkWithHref.getAttribute('href');this.processCalendarLink(href);linkWithHref.setAttribute('data-date-url',href)}}})}}
reSetupCalendarClickHandler(){this.removeCalendarHrefs()}
processCalendarLink(href){if(!href)return;const regex=/\/lich-nam-(\d{4})\/thang-(\d{1,2})\/ngay-(\d{1,2})/;const match=href.match(regex);if(match){const year=parseInt(match[1]);const month=parseInt(match[2]);const day=parseInt(match[3]);if(year&&month&&day){this.updatePageContent(year,month,day)}}}
removeCalendarHrefs(){const calendarBodyContainer=document.getElementById('calendar-body-container');if(!calendarBodyContainer)return;const calendarLinks=calendarBodyContainer.querySelectorAll('a[href*="/lich-nam-"]');calendarLinks.forEach(link=>{const href=link.getAttribute('href');if(href&&href.includes('/lich-nam-')){link.setAttribute('data-date-url',href)}})}
setupQuickPicker(){const quickPickerOverlay=document.getElementById('quickPickerOverlay');const quickPickerBtns=document.querySelectorAll('.quickPickerBtn');const closeQuickPicker=document.getElementById('closeQuickPicker');const viewDateBtn=document.getElementById('viewDateBtn');if(!quickPickerOverlay||quickPickerBtns.length===0||!closeQuickPicker||!viewDateBtn){return}
let currentPopupYear=this.currentYear;let currentPopupMonth=this.currentMonth;quickPickerBtns.forEach(btn=>{const newBtn=btn.cloneNode(!0);btn.parentNode.replaceChild(newBtn,btn)});document.querySelectorAll('.quickPickerBtn').forEach(btn=>{btn.addEventListener('click',async()=>{const currentDay=parseInt(document.getElementById('solarDay')?.value||this.currentDay);const currentMonth=parseInt(document.getElementById('solarMonth')?.value||this.currentMonth);const currentYear=parseInt(document.getElementById('solarYear')?.value||this.currentYear);currentPopupMonth=currentMonth;currentPopupYear=currentYear;const popupSolarDay=document.getElementById('solarDay');const popupSolarMonth=document.getElementById('solarMonth');const popupSolarYear=document.getElementById('solarYear');if(popupSolarDay)popupSolarDay.value=currentDay;if(popupSolarMonth)popupSolarMonth.value=currentMonth;if(popupSolarYear)popupSolarYear.value=currentYear;quickPickerOverlay.style.display='flex';setTimeout(()=>quickPickerOverlay.classList.add('show'),10);document.body.classList.add('modal-open');this.generatePopupCalendarOptimized(currentPopupMonth,currentPopupYear,currentDay);await this.updateLunarSelectsFromSolar(currentDay,currentMonth,currentYear)})});closeQuickPicker.addEventListener('click',()=>{this.closePopup(quickPickerOverlay)});quickPickerOverlay.addEventListener('click',(e)=>{if(e.target===quickPickerOverlay){this.closePopup(quickPickerOverlay)}});document.getElementById('prevMonthBtn').addEventListener('click',async()=>{currentPopupMonth--;if(currentPopupMonth<1){currentPopupMonth=12;currentPopupYear--}
this.updatePopupHeader(currentPopupMonth,currentPopupYear);await this.generatePopupCalendarOptimized(currentPopupMonth,currentPopupYear)});document.getElementById('nextMonthBtn').addEventListener('click',async()=>{currentPopupMonth++;if(currentPopupMonth>12){currentPopupMonth=1;currentPopupYear++}
this.updatePopupHeader(currentPopupMonth,currentPopupYear);await this.generatePopupCalendarOptimized(currentPopupMonth,currentPopupYear)});document.getElementById('solarDay').addEventListener('change',async()=>{await this.convertSolarToLunar();await this.syncCalendarWithSolarDate()});document.getElementById('solarMonth').addEventListener('change',async()=>{await this.convertSolarToLunar();await this.syncCalendarWithSolarDate()});document.getElementById('solarYear').addEventListener('change',async()=>{await this.convertSolarToLunar();await this.syncCalendarWithSolarDate()});document.getElementById('lunarDay').addEventListener('change',async()=>{await this.convertLunarToSolar()});document.getElementById('lunarMonth').addEventListener('change',this.debounce(async()=>{if(this.isUpdatingLunar)return;this.isUpdatingLunar=true;try{await this.convertLunarToSolar();await this.updateLunarDaysInMonth();this.saveLunarState()}finally{this.isUpdatingLunar=false}},300));document.getElementById('lunarYear').addEventListener('change',async()=>{await this.populateLunarMonthSelect();await this.convertLunarToSolar()});viewDateBtn.addEventListener('click',async()=>{const solarDay=parseInt(document.getElementById('solarDay').value);const solarMonth=parseInt(document.getElementById('solarMonth').value);const solarYear=parseInt(document.getElementById('solarYear').value);this.closePopup(quickPickerOverlay);this.updatePageContent(solarYear,solarMonth,solarDay)})}
updatePopupHeader(month,year){const monthSpan=document.getElementById('popupMonth');const yearSpan=document.getElementById('popupYear');if(monthSpan)monthSpan.textContent=month.toString().padStart(2,'0');if(yearSpan)yearSpan.textContent=year}
closePopup(overlay){overlay.classList.remove('show');document.body.classList.remove('modal-open');setTimeout(()=>{overlay.style.display='none'},300)}
async updatePopupIfOpen(year,month,day){const quickPickerOverlay=document.getElementById('quickPickerOverlay');if(quickPickerOverlay&&quickPickerOverlay.classList.contains('show')){this.updatePopupHeader(month,year);await this.generatePopupCalendarOptimized(month,year,day)}}
async updateSelectValues(year,month,day){const solarDaySelect=document.getElementById('solarDay');const solarMonthSelect=document.getElementById('solarMonth');const solarYearSelect=document.getElementById('solarYear');if(solarDaySelect)solarDaySelect.value=day;if(solarMonthSelect)solarMonthSelect.value=month;if(solarYearSelect)solarYearSelect.value=year;try{const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');const response=await fetch('/api/convert-solar-to-lunar',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({solarDay:day,solarMonth:month,solarYear:year})});const data=await response.json();if(data.success){const lunarDaySelect=document.getElementById('lunarDay');const lunarMonthSelect=document.getElementById('lunarMonth');const lunarYearSelect=document.getElementById('lunarYear');if(lunarDaySelect)lunarDaySelect.value=data.lunarDay;if(lunarMonthSelect)lunarMonthSelect.value=data.lunarMonth;if(lunarYearSelect)lunarYearSelect.value=data.lunarYear}}catch(error){}}
async updateLunarSelectsFromSolar(day,month,year){try{const savedState=this.restoreLunarState();const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');const response=await fetch('/api/convert-solar-to-lunar',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({solarDay:day,solarMonth:month,solarYear:year})});const data=await response.json();if(data.success){await this.populateLunarMonthSelect(data.lunarYear);const lunarDaySelect=document.getElementById('lunarDay');const lunarYearSelect=document.getElementById('lunarYear');if(lunarDaySelect)lunarDaySelect.value=data.lunarDay;if(lunarYearSelect)lunarYearSelect.value=data.lunarYear;if(savedState&&savedState.year==data.lunarYear&&savedState.month==data.lunarMonth){await this.selectCorrectLunarMonth(parseInt(savedState.month),savedState.isLeap||false)}else{await this.selectCorrectLunarMonth(data.lunarMonth,data.isLeap||false)}}}catch(error){}}
async fetchLunarDatesForMonth(month,year,daysInMonth){const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');try{const response=await fetch('/api/get-month-lunar-dates',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({month:month,year:year})});const data=await response.json();if(data.success&&data.dates){return data.dates}else{console.error('L·ªói khi l·∫•y d·ªØ li·ªáu √¢m l·ªãch:',data.error);return{}}}catch(error){console.error('L·ªói khi l·∫•y d·ªØ li·ªáu √¢m l·ªãch cho th√°ng:',error);return{}}}
async syncCalendarWithSolarDate(){const day=parseInt(document.getElementById('solarDay').value);const month=parseInt(document.getElementById('solarMonth').value);const year=parseInt(document.getElementById('solarYear').value);this.updatePopupHeader(month,year);await this.generatePopupCalendarOptimized(month,year,day)}
async convertLunarToSolar(){const lunarDay=document.getElementById('lunarDay').value;const lunarMonth=document.getElementById('lunarMonth').value;const lunarYear=document.getElementById('lunarYear').value;if(!lunarDay||!lunarMonth||!lunarYear)return;try{const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');const lunarMonthSelect=document.getElementById('lunarMonth');const selectedOption=lunarMonthSelect.options[lunarMonthSelect.selectedIndex];const isLeapMonth=selectedOption&&selectedOption.dataset.isLeap==='1';const response=await fetch('/api/convert-lunar-to-solar',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({lunarDay:parseInt(lunarDay),lunarMonth:parseInt(lunarMonth),lunarYear:parseInt(lunarYear),isLeap:isLeapMonth})});const data=await response.json();if(data.success){document.getElementById('solarDay').value=data.solarDay;document.getElementById('solarMonth').value=data.solarMonth;document.getElementById('solarYear').value=data.solarYear;this.updatePopupHeader(data.solarMonth,data.solarYear);await this.generatePopupCalendarOptimized(data.solarMonth,data.solarYear,data.solarDay)}}catch(error){console.error('Error converting lunar to solar:',error)}}
convertSolarToLunarSync(day,month,year){const solarDate=new Date(year,month-1,day);const lunarNewYear2024=new Date(2024,1,10);const daysDiff=Math.floor((solarDate-lunarNewYear2024)/(1000*60*60*24));const lunarDay=((daysDiff%30)+1);const lunarMonth=Math.floor(daysDiff/30)%12+1;return{lunarDay:lunarDay>0?lunarDay:1,lunarMonth:lunarMonth>0?lunarMonth:1,lunarYear:year}}
async convertSolarToLunar(){const solarDay=document.getElementById('solarDay').value;const solarMonth=document.getElementById('solarMonth').value;const solarYear=document.getElementById('solarYear').value;if(!solarDay||!solarMonth||!solarYear)return;try{const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');const response=await fetch('/api/convert-solar-to-lunar',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({solarDay:parseInt(solarDay),solarMonth:parseInt(solarMonth),solarYear:parseInt(solarYear)})});const data=await response.json();if(data.success){await this.populateLunarMonthSelect(data.lunarYear);document.getElementById('lunarDay').value=data.lunarDay;document.getElementById('lunarYear').value=data.lunarYear;await this.selectCorrectLunarMonth(data.lunarMonth,data.isLeap||false)}}catch(error){console.error('Error converting solar to lunar:',error)}}
setupPopstateHandler(){window.addEventListener('popstate',(event)=>{if(event.state&&event.state.year&&event.state.month&&event.state.day){const{year,month,day}=event.state;this.updatePageContentFromHistory(year,month,day)}else{const currentUrl=window.location.pathname;const urlMatch=currentUrl.match(/\/lich-nam-(\d{4})\/thang-(\d{1,2})\/ngay-(\d{1,2})/);if(urlMatch){const year=parseInt(urlMatch[1]);const month=parseInt(urlMatch[2]);const day=parseInt(urlMatch[3]);this.updatePageContentFromHistory(year,month,day)}}})}
async updatePageContentFromHistory(year,month,day){const csrfToken=document.querySelector('meta[name="csrf-token"]').getAttribute('content');document.body.style.cursor='wait';try{const response=await fetch(this.ajaxUrl,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':csrfToken,'Accept':'application/json'},body:JSON.stringify({yy:year,mm:month,dd:day,birthdate:null})});const data=await response.json();if(data.success){this.currentYear=year;this.currentMonth=month;this.currentDay=day;await this.updateSelectValues(year,month,day);await this.updatePopupIfOpen(year,month,day);this.updateUIElements(data.data);this.updateChart(data.data.labels,data.data.dataValues)}}catch(error){console.error('Error:',error);alert('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.')}finally{document.body.style.cursor='default'}}
async populateLunarMonthSelect(year=null){const lunarYear=year||document.getElementById('lunarYear').value;const lunarMonthSelect=document.getElementById('lunarMonth');if(!lunarMonthSelect||!lunarYear)return;const currentValue=lunarMonthSelect.value;const currentIsLeap=lunarMonthSelect.options[lunarMonthSelect.selectedIndex]?.dataset?.isLeap==='1';lunarMonthSelect.innerHTML='<option value="">ƒêang t·∫£i...</option>';lunarMonthSelect.disabled=true;try{let leapMonthNumber=0;const knownLeapYears={2025:6,2028:5,2031:3,2033:11,2036:6,2039:5,2042:2,2044:7,2047:5,2050:3,2052:8,2055:6,2058:4,2061:3,2063:7,2066:5,2069:4,2071:8,2074:6,2077:4,2080:3,2082:7,2085:5,2088:4,2090:6,2093:5,2096:2,2099:7,2101:5};if(knownLeapYears[parseInt(lunarYear)]){leapMonthNumber=knownLeapYears[parseInt(lunarYear)]}else{for(let m=1;m<=12;m++){try{const response=await fetch('/api/get-lunar-month-days',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').getAttribute('content')},body:JSON.stringify({month:m,year:parseInt(lunarYear),isLeap:1})});if(!response.ok)break;const data=await response.json();if(data.success&&data.days>0){leapMonthNumber=m;break}}catch(error){console.error('Error checking leap month:',error);break}}}
lunarMonthSelect.innerHTML='<option value="">Th√°ng</option>';lunarMonthSelect.disabled=false;for(let i=1;i<=12;i++){const option=document.createElement('option');option.value=i;option.textContent=`Th√°ng ${i}`;option.dataset.isLeap='0';lunarMonthSelect.appendChild(option);if(i===leapMonthNumber){const leapOption=document.createElement('option');leapOption.value=i;leapOption.textContent=`Th√°ng ${i} nhu·∫≠n`;leapOption.dataset.isLeap='1';lunarMonthSelect.appendChild(leapOption)}}
if(currentValue){const wasLeapAndStillExists=currentIsLeap&&leapMonthNumber==currentValue;const shouldUseLeap=wasLeapAndStillExists;this.selectCorrectLunarMonth(parseInt(currentValue),shouldUseLeap)}}catch(error){console.error('Error populating lunar months:',error);lunarMonthSelect.innerHTML='<option value="">L·ªói t·∫£i d·ªØ li·ªáu</option>';lunarMonthSelect.disabled=false}}
async selectCorrectLunarMonth(monthValue,isLeap=false,skipUpdate=false){const lunarMonthSelect=document.getElementById('lunarMonth');if(!lunarMonthSelect)return;for(let i=0;i<lunarMonthSelect.options.length;i++){const option=lunarMonthSelect.options[i];if(option.value==monthValue){if((isLeap&&option.dataset.isLeap==='1')||(!isLeap&&option.dataset.isLeap!=='1')){lunarMonthSelect.selectedIndex=i;if(!skipUpdate){await this.updateLunarDaysInMonth()}
this.saveLunarState();break}}}}
saveLunarState(){try{const lunarMonth=document.getElementById('lunarMonth');const lunarDay=document.getElementById('lunarDay');const lunarYear=document.getElementById('lunarYear');if(lunarMonth&&lunarDay&&lunarYear){const selectedOption=lunarMonth.options[lunarMonth.selectedIndex];const state={month:lunarMonth.value,day:lunarDay.value,year:lunarYear.value,isLeap:selectedOption?.dataset?.isLeap==='1'};localStorage.setItem('lunarCalendarState',JSON.stringify(state))}}catch(error){console.error('Error saving lunar state:',error)}}
restoreLunarState(){try{const savedState=localStorage.getItem('lunarCalendarState');if(savedState){return JSON.parse(savedState)}}catch(error){console.error('Error restoring lunar state:',error)}return null}
async updateLunarDaysInMonth(){const lunarDay=document.getElementById('lunarDay');const lunarMonth=document.getElementById('lunarMonth');const lunarYear=document.getElementById('lunarYear');if(!lunarDay||!lunarMonth||!lunarYear)return;const month=parseInt(lunarMonth.value);const year=parseInt(lunarYear.value);const currentDay=parseInt(lunarDay.value);if(!month||!year)return;const selectedOption=lunarMonth.options[lunarMonth.selectedIndex];const isLeapMonth=selectedOption&&selectedOption.dataset.isLeap==='1';try{const response=await fetch('/api/get-lunar-month-days',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').getAttribute('content')},body:JSON.stringify({month:month,year:year,isLeap:isLeapMonth?1:0})});if(!response.ok){console.error('API response not ok:',response.status);const fallbackDays=isLeapMonth?29:30;lunarDay.innerHTML='<option value="">Ng√†y</option>';for(let i=1;i<=fallbackDays;i++){const option=document.createElement('option');option.value=i;option.textContent=String(i).padStart(2,'0');lunarDay.appendChild(option)}
return}
const data=await response.json();if(data.success&&data.days>0){const daysInMonth=data.days;lunarDay.innerHTML='<option value="">Ng√†y</option>';for(let i=1;i<=daysInMonth;i++){const option=document.createElement('option');option.value=i;option.textContent=String(i).padStart(2,'0');lunarDay.appendChild(option)}
if(currentDay&&currentDay<=daysInMonth){lunarDay.value=currentDay}}}catch(error){console.error('Error getting lunar month days:',error)}}
}
window.initLunarCalendarApp=function(config){new LunarCalendarApp(config)}